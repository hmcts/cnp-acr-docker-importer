name: Copy Docker Public Images
trigger:
- master

variables:
  acrName: hmctssandbox 
  targetRegistry: hmctssandbox.azurecr.io
  serviceConnection: 'azurerm-sandbox'
  dockerImage: 'postgres'
  dockerImageVersion: '11.9'

pool:
  vmImage: 'Ubuntu 16.04'

steps:
- task: DockerInstaller@0
  displayName: 'Install DockerCLI'
  inputs:
    dockerVersion: '19.03.13'

- task: AzureCLI@2
  displayName: "Login to ACR"
  inputs:
    azureSubscription: $(serviceConnection)
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: 'az acr login --name $(acrName)'

- task: Bash@3
  displayName: "Pull the official image"
  inputs:
    targetType: 'inline'
    script: 'docker pull $(dockerImage)/$(dockerImageVersion)'

- task: Bash@3
  displayName: "Create an alias of the image"
  inputs:
    targetType: 'inline'
    script: 'docker tag $(dockerImage):$(dockerImageVersion) $(acrName).azurecr.io/base/$(dockerImage):$(dockerImageVersion)'

- task: Bash@3
  displayName: "Push the image to ACR"
  inputs:
    targetType: 'inline'
    script: 'docker push $(acrName)/base/$(dockerImage):$(dockerImageVersion)'